출처 : https://blog.naver.com/thumbdown/220258042259


PSD( Position Sensitive Device ) 센서는 적외선, 레이져, CCD( Charge Cupled Device )등을 이용한 대상 오브젝트까지의 거리를 측정하는 센서들의 통칭이다. 그 중 그나마 주변에서 비교적 저렴한 가격으로 쉽게 구할 수 있는 SHARP의 적외선 방식 PSD 센서의 사용법을 알아보자.



SHARP사의 적외선 PSD센서는 적외선 발광부( Light Emitter Side )와 수광부( Light Detector Side )로 구성되어있다.



거리 측정 원리는 발광부에서 적외선을 쏘아 수광부에 그반사파가 검지되는 각도로 거리를 판단한다. 발광부의 중심과 수광부의 중심을 연결하는 선분을 밑변으로 하는 이등변 삼각형의 높이가 측정대상과의 거리가 된다. 따라서 이 삼각형의 밑변과 등변이 이루는 각은 거리가 멀수록 ( 삼각형의 높이가  클수록 ) 커지고, 거리가 가까울수록 ( 삼각형의 높이가 작을 수록 ) 작아진다. 따라서 오른쪽 그림의 예에서 보여지듯이 거리 A와 거리 B는 B > A 임을 알 수 있다. 이 때 이등변 삼각형의 밑각 α와 β 역시 β > α 가 되는 것을 알 수 있다. 이 원리를 이용하여 거리를 측정한다.



센서의 출력전압은 수광부에서 검지되는 이 각의 크기에 따라 변화하며, 그 관계는 SHARP GP2Y0A21의 경우 아래의 그래프와 같다. ( 센서의 모델명에 따라 거리와 출력전압의 관계를 나타내는 특성곡선이 다르므로, 사용하고자 하는 센서의 데이터시트에서 이를 찾아봐야 한다. 몇 가지 모델의 데이터 시트와 그 특성곡선 그래프를 확대한 이미지를 첨부파일에 넣어두었으니 참고하자. )특성첨부한 데이터시트의 출력전압과 거리와의 관계를 표현한 특성곡선으로 표시된다. 따라서 이 곡선을 수식으로 표현하여 프로그램에 적용하면, 거리를 구할 수 있다.



일단 이 센서로 거리를 측정하려면 거리에 따른 출력전압의 변화를 아두이노( 또는 사용하는 MCU 보드 )에 전달하여야 한다. 센서의 출력이 연속적인 전압의 변화, 즉 일종의 아날로그 값으로 출력되므로, ADC( Analog to Digital Converter )의 입력에 센서의 출력을 연결하여, A-D 컨버팅하여 거리를 계산하여야 한다. ( ADC가 없는 MCU보드를 사용할 경우, ADC를 추가 장착하여, 그 입력으로 넣어주고, 출력을 MCU가 받아 사용해야 한다. ) 아두이노( 우노 R3 기준 )의 경우 아날로그 입력으로 사용할 수 있는 A0-A5, 6개의 ADC 채널을 가지고 있다. 이 중 하나에 연결하면 된다.



ADC( Analog to Digital Converter )는 말 그대로 아날로그 값을  디지탈값으로 변환해주는 장치이다. 아두이노의 MCU는 Atmega-328P이다.  Atmega-328P은 10비트 ADC가 내장되어 있는데 여기서 10비트는 해상도( Resolution )을 말한다. 즉 0에서 5V의 전압을 ADC에 입력할 경우 0-5까지의 변화를 '0 에서 ( 210-1 ) 까지' → '0 에서 (1024-1) 까지' → '0 에서 1023 까지'의 1024(210)단계의 값에 대응 시킨다는 뜻이다. 예를 들자면,

 - ADC입력전압이 0.00V일때, ADC결과는    0, 즉, 5 : 1023 =    0 : x, 5 x = 1023 × 0.00, x = ( 1023 × 0.00 ) / 5 =    0,

 - ADC입력전압이 1.25V일때, ADC결과는  255, 즉, 5 : 1023 = 1.25 : x, 5 x = 1023 × 1.25, x = ( 1023 × 1.25 ) / 5 =  255,

 - ADC입력전압이 2.50V일때, ADC결과는  511, 즉, 5 : 1023 = 2.50 : x, 5 x = 1023 × 2.50, x = ( 1023 × 2.50 ) / 5 =  511,

 - ADC입력전압이 3.75V일때, ADC결과는  767, 즉, 5 : 1023 = 3.75 : x, 5 x = 1023 × 3.75, x = ( 1023 × 3.75 ) / 5 =  767,

 - ADC입력전압이 5.00V일때, ADC결과는 1023,​ 즉, 5 : 1023 = 5.00 : x, 5 x = 1023 × 5.00, x = ( 1023 × 5.00 ) / 5 = 1023

​ 이 될 것이라는 것을 예상할 수 있다.

​ ( 만약 ADC가 8비트 ADC라면 ADC 결과는 0 에서 ( 28 - 1), 즉 0 에서 255 사이의 값을 갖게 될 것이다,

    위에서 처럼 0V, 1.25V, 2.5V, 3.75V, 5V 가 이 ADC의 입력일 경우 ADC결과는 0, 63, 127, 191, 255 의 값을 갖게 된다. )



 마찬가지로, ADC값에서 전압을 구하려면, V = ( 5 × ADC ) / 1023(V)로 구할 수 있다. ( V = ( 5000 × ADC ) / 1023 (mV) )




 ----


 이 그래프를 수식으로 표현할 수만 있으면 간단히 거리를 측정할 수 있다. 수학적인 능력이 부족하고, Matlab같은 툴도 없는 관계로, 위 그래프에 표시한 것 처럼 모눈을 좀더 작은 단위로 나누고, 빨간색 점을 기울기가 달라지는 변곡점으로 간주하고서 10개의 직선의 집합으로 해석해 보았다. 
 

 SHARP GP2Y0A21의 전압(mv)에 대한 거리(mm)분석

 전압(mv)

 전압변화량(mv)

 거리(mm)

 거리변화량(mm)

거리변화에 대한

전압변화(기울기)

 x = 0 일 때의

 y 값 ( y절편 )﻿ 

400 

 

800 

 

 

 
440 

40 

700 

-100 

-  0.40 

720 

500 

60 

600 

-100 

-  0.60 

860 

595 

95 

500 

-100 

-  0.95 

1070 

730 

135 

400 

-100 

-  1.35 

1270 

910 

180 

300 

-100 

-  1.80 

1450 

1050 

140 

253 

- 47 

-  2.98 

1804 

1300 

250 

200 

- 53 

-  4.72 

2244 

1660 

360 

150 

- 50 

-  7.20 

2740 

2300 

640 

100 

- 50 

- 12.80 

3580 

2956 

656 

70 

- 30 

- 21.87 

4487 

  


 10개 측정구간의 직선의 방정식

 구간

 해당 구간의 직선의 방정식

 거리

  400(mv) -  440(mv)

 y = -  0.40 x +  720

 x = ( y -  720 ) / -  0.40

  440(mv) -  500(mv)

 y = -  0.60 x +  860

 x = ( y -  860 ) / -  0.60

  500(mv) -  595(mv)

 y = -  0.95 x + 1070

 x = ( y - 1070 ) / -  0.95

  595(mv) -  730(mv)

 y = -  1.35 x + 1270

 x = ( y - 1270 ) / -  1.35

  730(mv) -  910(mv)

 y = -  1.80 x + 1450

 x = ( y - 1450 ) / -  1.80

  910(mv) - 1050(mv)

 y = -  2.98 x + 1804

 x = ( y - 1804 ) / -  2.98

 1050(mv) - 1300(mv)

 y = -  4.72 x + 2244

 x = ( y - 2244 ) / -  4.72

 1300(mv) - 1660(mv)

 y = -  7.20 x + 2740

 x = ( y - 2740 ) / -  7.20

 1660(mv) - 2300(mv)

 y = - 12.80 x + 3580

 x = ( y - 3580 ) / - 12.80

 2300(mv) - 2956(mv)

 y = - 21.87 x + 4487

 x = ( y - 4487 ) / - 21.87

  

​위 표에 나타낸 직선의 방정식에서 x 는 거리, y는 전압에 해당한다. 센서의 출력값이 속한 구간 직선의 방정식의 y에 센서 출력값을 대입하여 얻어지는 x값이 측정된 거리에 해당한다.
​
​위 자료를 바탕으로 아두이노에서 SHARP GP2Y0A21 PSD 센서를 이용하여 거리를 측정해보자.
​
회로구성
SHARP GP2Y0A21 PSD 센서와 아두이노의 연결은 오른쪽 그림과 같이 하면된다.
​적색 : 센서 전원
​흑색 : GND
​황색 : 센서 출력
오른쪽 회로에서는 센서 출력을 A0에 연결했다. ( A0 - A5 중 하나에 연결하면 된다. ) 

아두이노 스케치 작성
 // Test Mesuring Distance with GP2Y0A21



 void setup()    //---------------------------------
 {
   pinMode(A0,INPUT);
   Serial.begin(9600);
   Serial.println("Test GP2Y0A21");
 }



 void loop()    //--------------------------------

 {
   long dist  = 0;
   long adc   = analogRead(A0);
   long mVolt = ( 5000*adc ) / 1023;
  
   if     ( ( mVolt >=  400 ) && ( mVolt <  440 ) )
     dist = ( 100 * mVolt -  72000 ) /   -40;
  
   else if( ( mVolt >=  440 ) && ( mVolt <  500 ) )
     dist = ( 100 * mVolt -  86000 ) /   -60;
    
   else if( ( mVolt >=  500 ) && ( mVolt <  595 ) )
     dist = ( 100 * mVolt - 107000 ) /   -95;
    
   else if( ( mVolt >=  595 ) && ( mVolt <  730 ) )
     dist = ( 100 * mVolt - 127000 ) /  -135;
    
   else if( ( mVolt >=  730 ) && ( mVolt <  910 ) )
     dist = ( 100 * mVolt - 145000 ) /  -180;
    
   else if( ( mVolt >=  910 ) && ( mVolt < 1050 ) )
     dist = ( 100 * mVolt - 180400 ) /  -298;
    
   else if( ( mVolt >= 1050 ) && ( mVolt < 1300 ) )
     dist = ( 100 * mVolt - 224400 ) /  -472;
    
   else if( ( mVolt >= 1300 ) && ( mVolt < 1660 ) )
     dist = ( 100 * mVolt - 274000 ) /  -720;
    
   else if( ( mVolt >= 1660 ) && ( mVolt < 2300 ) )
     dist = ( 100 * mVolt - 358000 ) / -1280;
    
   else if( ( mVolt >= 2300 ) && ( mVolt < 2956 ) )
     dist = ( 100 * mVolt - 448700 ) / -2187;
  
   else
     dist = 9999;
  
   if( dist != 9999 )
   {
     Serial.print("distance = ");
     Serial.print(dist);
     Serial.println(" (mm)");
   }
  
   else
     Serial.println("Out of range!!!");
  
   delay(500);
 }

 // GP2Y0A21를 이용한 거리측정 테스트



 setup() 함수 정의

 {

   A0 핀을 입력으로 설정

   9600bps 시리얼통신 사용

   ​"Test GP2Y0A21" 문자열을 시리얼로 출력

 }



 loop() 함수 정의

 {

   long형 변수 dist 선언 및 '0'으로 초기화

   A0 입력을 A-D 컨버팅하여 long형 변수 adc에 치환

   long형 변수 mVolt에 adc값으로 구한 mV단위 전압값 치환



   mVolt 값이 400 mV - 440 mV 구간의 값이면

     거리 = ( mVolt - 720 ) * 100 / -40

​     // 부동소수점 계산을 피하려고, 분모, 분자에 100을 곱하여 계산

   mVolt 값이 440 mV - 500 mV 구간의 값이면

     거리(mm) = ( mVolt - 720 ) * 100 / -40



   mVolt 값이 500 mV -  595 mV 구간의 값이면

     거리(mm) = ( 100 * mVolt -  86000 ) / -60



   mVolt 값이 595 V -  730 mV 구간의 값이면

     거리(mm) = ( 100 * mVolt - 107000 ) / -95



   mVolt 값이 730 mV -  910 mV 구간의 값이면

     거리(mm) = ( 100 * mVolt - 127000 ) / -135



   mVolt 값이 910 mV - 1050 mV 구간의 값이면

     거리(mm) = ( 100 * mVolt - 145000 ) / -180



   mVolt 값이 1050 mV - 1300 mV 구간의 값이면

     거리(mm) = ( 100 * mVolt - 180400 ) / -298



   mVolt 값이 1300 mV - 1660 mV 구간의 값이면

     거리(mm) = ( 100 * mVolt - 224400 ) / -472



   mVolt 값이 1660 mV - 2300 mV 구간의 값이면

     거리(mm) = ( 100 * mVolt - 274000 ) / -720



   mVolt 값이 2300 mV - 2956 mV 구간의 값이면

     거리(mm) = ( 100 * mVolt - 358000 ) / -1280



   mVolt 값이 400보다 작거나, 2956이상이면

     거리(mm) = 9999

​

   거리값이 9999가 아니면

   {

     "distance = " 문자열을 시리얼로 출력

     dist값을 시리얼로 출력

     " (mm)" 문자열을 시리얼로 출력 후 줄바꾸고, 커서 홈

   }

​

   거리값이 9999이면

     "Out of range!!!" 문자열을 시리얼로 출력 후 줄바꾸고, 커서 홈

​

   0.5초 대기

 }

아두이노의 경우 컴파일 시 별도의 옵션을 지정해 주지 않아도 부동소숫점 처리를 해주지만, 그렇다고 해도, MCU레벨의 프로그램에서 부동소숫점 계산은 부하가 많이 걸리는 작업이다. 차라리 10, 100, 1000,... 을 곱해서 소숫점을 없에고 정수형으로 처리한 후 다시 나누어 주면, 처리 스텝은 늘어나지만 처리속도는 부동소숫점 계산을 하는 것 보다 빠르다. 위 예제 정도의 간단한 프로그램은 크게 속도가 문제되지 않으므로, 부동소숫점 계산을 하여도 지장이 없다. 계산에 사용되는 변수들을 float로 선언하고, 'dist = ( y -  720 ) / -0.4;'와 같이 처리해도 무방하다.
단위를 굳이 mm나 mV로 처리한 이유도 역시 정수형으로 처리하기 위해서다. 정수형 계산에서 소숫점 이하가 절사되어 정밀도가 떨어질 수 있기 때문에, 단위를 낮춰 유효숫자가 소숫점 위로 올라오도록 하기 위해서이다.


아래 그림은 위 스케치 업로드 후 시리얼모니터 실행 화면이다.

​
​
다음은 역시 SHARP社의 적외선 PSD센서 중 하나인 GP2Y0A02YK와  GP2Y0A41SK의 특성곡선이다. ( 센서 구입 시 들어 있는 데이터시트 복사본의 경우 이 곡선이 무척 작게 복사되어 있다. 해상도를 높혀 스캔하고, 작은 눈금을 그려넣는 작업을 일일이 해서 만들어진 결과물인 만큼 가져다 쓸 때에는 출처정도는 밝혀주기 바란다. )

​

​
이 강좌글 작성에 필요한 자료 검색 중 Arduino Playground에 GP2Y0A02와 GP2Y0A21 센서에 대한 잘 만들어진 아두이노 라이브러리를 발견하였다. 진작 알았으면, 그 라이브러리 분석과, 사용법 강좌 하나로 마무리 했을 텐데, 좀 완성도 떨어지는 방법을 소개했다. 그래서 샤프 적외선 PSD센서 관련 강좌를 1편 더 작성하여 차회 강좌에 앞에서 언급한 아두이노 라이브러리( SharpIR ) 분석과, 사용법강좌를 올리도록 하겠다. 이 글은 그저 원리 이해에 초점을 맞춰서 읽고, 코드는 차회 강좌를 참고하여 작성하도록 하자.